<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editorial Tracker</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">
        <header>
            <h1>Editorial Tracker</h1>
            <button class="btn" onclick="openModal()">+ New Entry</button>
        </header>

        <div class="stats-row">
            <div class="stat-card">
                <span class="stat-label">Active Reviews</span>
                <span class="stat-value" id="stat-active">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Pending Decisions</span>
                <span class="stat-value" id="stat-pending">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Completed</span>
                <span class="stat-value" id="stat-completed">0</span>
            </div>
        </div>

        <div class="table-card">
            <table id="items-table">
                <thead>
                    <tr>
                        <th onclick="sort('title')">Title<span id="sort-title"></span></th>
                        <th onclick="sort('reference_id')">Manuscript ID<span id="sort-reference_id"></span></th>
                        <th onclick="sort('venue')">Venue<span id="sort-venue"></span></th>
                        <th onclick="sort('due_date')">Due Date<span id="sort-due_date"></span></th>
                        <th onclick="sort('status')">Status<span id="sort-status"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Items will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3 id="form-title" style="margin-bottom: 1.5rem;">Add New Item</h3>
            <form id="item-form">
                <input type="hidden" id="item-id">

                <div class="input-group">
                    <input type="text" id="title" placeholder="Title" required>
                </div>

                <div class="input-group">
                    <input type="text" id="reference_id" placeholder="Manuscript ID (Optional)">
                </div>

                <div class="input-group">
                    <input type="text" id="venue" list="venue-list" placeholder="Venue (Journal/Conf)">
                    <datalist id="venue-list"></datalist>
                </div>

                <div class="input-group">
                    <input type="date" id="due_date">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn" id="submit-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api/items';
        let currentSort = 'due_date';
        let currentOrder = 'ASC';
        let allItems = [];

        async function loadVenues() {
            try {
                const res = await fetch('/api/venues');
                const venues = await res.json();
                const datalist = document.getElementById('venue-list');
                datalist.innerHTML = venues.map(v => `<option value="${v}">`).join('');
            } catch (e) { console.error("Error loading venues", e); }
        }

        async function loadItems() {
            try {
                const res = await fetch(`${API_URL}?sort=${currentSort}&order=${currentOrder}`);
                allItems = await res.json();

                renderTable(allItems);
                updateStats(allItems);
                updateSortIcons();
            } catch (e) { console.error("Error loading items", e); }
        }

        function renderTable(items) {
            const tbody = document.querySelector('#items-table tbody');
            tbody.innerHTML = '';

            items.forEach(item => {
                const safeItem = JSON.stringify(item).replace(/"/g, '&quot;');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${item.title}</td>
                <td>${item.reference_id || '<span style="color:#666;">-</span>'}</td>
                <td>${item.venue || '<span style="color:#666;">-</span>'}</td>
                <td>${item.due_date || '<span style="color:#666;">-</span>'}</td>
                <td>
                    <select class="status-select" onchange="updateStatus(${item.id}, this.value)">
                        <option value="invited" ${item.status === 'invited' ? 'selected' : ''}>Invited</option>
                        <option value="active" ${item.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="completed" ${item.status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="rejected" ${item.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editItem(${safeItem})">Edit</button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        function updateStats(items) {
            const activeCount = items.filter(i => ['active', 'invited'].includes(i.status)).length;
            const pendingCount = items.filter(i => ['pending', 'in_review'].includes(i.status)).length;
            // Completed includes 'completed', 'accepted', 'rejected'
            const completedCount = items.filter(i => ['completed', 'accepted', 'rejected'].includes(i.status)).length;

            document.getElementById('stat-active').innerText = activeCount;
            document.getElementById('stat-pending').innerText = pendingCount;
            document.getElementById('stat-completed').innerText = completedCount;
        }

        function sort(column) {
            if (currentSort === column) {
                currentOrder = currentOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                currentSort = column;
                currentOrder = 'ASC';
            }
            loadItems();
        }

        function updateSortIcons() {
            document.querySelectorAll('th span').forEach(span => span.innerText = '');
            const arrow = currentOrder === 'ASC' ? ' ▲' : ' ▼';
            const span = document.getElementById(`sort-${currentSort}`);
            if (span) span.innerText = arrow;
        }

        // Modal / Form Logic
        function openModal() {
            document.getElementById('modal-overlay').classList.add('open');
            // If opening empty, ensure reset
            if (!document.getElementById('item-id').value) {
                resetForm();
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('open');
            resetForm();
        }

        // Close modal on outside click
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') closeModal();
        });

        function editItem(item) {
            document.getElementById('form-title').innerText = "Edit Item";
            document.getElementById('item-id').value = item.id;
            document.getElementById('title').value = item.title;
            document.getElementById('reference_id').value = item.reference_id || '';
            document.getElementById('venue').value = item.venue || '';
            document.getElementById('due_date').value = item.due_date || '';
            document.getElementById('submit-btn').innerText = "Update";

            document.getElementById('modal-overlay').classList.add('open');
        }

        function resetForm() {
            document.getElementById('item-form').reset();
            document.getElementById('item-id').value = '';
            document.getElementById('form-title').innerText = "Add New Item";
            document.getElementById('submit-btn').innerText = "Save";
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const title = document.getElementById('title').value;
            const reference_id = document.getElementById('reference_id').value;
            const venue = document.getElementById('venue').value;
            const due_date = document.getElementById('due_date').value;

            const payload = { title, reference_id, venue, due_date };

            if (id) {
                await fetch(`${API_URL}/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } else {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            }

            closeModal();
            loadItems();
            loadVenues();
        }

        async function updateStatus(id, status) {
            await fetch(`${API_URL}/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            // Reload to update stats
            loadItems();
        }

        document.getElementById('item-form').addEventListener('submit', handleSubmit);

        // Initial load
        loadItems();
        loadVenues();
    </script>
</body>

</html>